---
title: "SOLUS Data Processing"
output: html_notebook
---


```{r}
library(sf)
library(terra)
```

```{r}
# Review SOLUS layers
solus_layers <- read.csv("C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/Final_Layer_Table_20231215.csv")
```

```{r}
# Function to load a raster from a URL using the terra package
load_raster <- function(url) {
  tryCatch({
    rast(url)
  }, error = function(e) {
    message("Error loading raster from URL: ", url, " - ", e$message)
    return(NULL)
  })
}

# Function to mask, trim, and write raster to disk using the terra package
process_raster <- function(raster, shapefile, output_path) {
  tryCatch({
    masked_raster <- mask(raster, shapefile)
    trimmed_raster <- trim(masked_raster)
    writeRaster(trimmed_raster, filename = output_path, overwrite = TRUE)
    message("Successfully processed and saved raster to: ", output_path)
  }, error = function(e) {
    message("Error processing raster: ", e$message)
  })
}

get_soil_data <- function(shapefile, output_path, subfolder) {
  # Create output directory
  output_directory <- file.path(output_path, subfolder)
  
  # Check if the directory exists
  if (!dir.exists(output_directory)) {
    dir.create(output_directory, recursive = TRUE)
    message("Directory created: ", output_directory)
  } else {
    message("Directory already exists: ", output_directory)
  }
  
  depths <- c(0, 15, 30, 60, 100, 150)
  base_url <- "/vsicurl/https://storage.googleapis.com/solus100notpub"
  properties <- c("ph1to1h2o", "dbovendry", "fragvol")
  
  # Create a flat list of URLs for each property at each depth
  urls_list <- unlist(lapply(properties, function(prop) {
    lapply(depths, function(depth) {
      sprintf("%s/%s_%s_cm_p.tif", base_url, prop, depth)
    })
  }))
  
  # Process each raster file sequentially
  for (i in 1:length(urls_list)) {
    url <- urls_list[i]
    raster <- load_raster(url)
    
    # Check if raster is loaded correctly
    if (is.null(raster)) {
      message("Skipping raster for URL: ", url, " due to load failure.")
      next
    }
    
    # Compare CRS of shapefile and raster
    if (!identical(st_crs(shapefile)$wkt, crs(raster))) {
      shapefile <- st_transform(shapefile, crs(raster))
      message("Transformed shapefile CRS to match raster.")
    }
    
    # Extract property and depth from URL for naming the output file
    url_parts <- strsplit(basename(url), "_")[[1]]
    prop <- url_parts[1]
    depth <- gsub("cm_p.tif", "", url_parts[2])
    
    output_file_path <- file.path(output_directory, sprintf("%s_%s_%s.tif", prop, depth, basename(output_directory)))
    
    # Check if the output file already exists
    if (file.exists(output_file_path)) {
      message("Output file already exists: ", output_file_path, " - Skipping processing.")
      next
    }
    
    process_raster(raster, shapefile, output_file_path)
  }
  
  # Process additional specific rasters
  additional_urls <- c(
    sprintf("%s/anylithicdpt_cm_p.tif", base_url),
    sprintf("%s/resdept_cm_p.tif", base_url)
  )
  
  for (url in additional_urls) {
    raster <- load_raster(url)
    
    if (is.null(raster)) {
      message("Skipping raster for URL: ", url, " due to load failure.")
      next
    }
    
    name <- strsplit(basename(url), "_cm_p.tif")[[1]]
    output_file_path <- file.path(output_directory, paste0(name, "_", basename(output_directory), ".tif"))
    
    # Check if the output file already exists
    if (file.exists(output_file_path)) {
      message("Output file already exists: ", output_file_path, " - Skipping processing.")
      next
    }
    
    process_raster(raster, shapefile, output_file_path)
  }
  
  # SoilGrids100 (Ramcharan et al., 2017)
  soilgrids_urls <- list(
    '/vsicurl/https://scholarsphere.psu.edu/resources/9f534068-9c9a-44d8-b247-8bfc36e61896/downloads/5787',
    '/vsicurl/https://scholarsphere.psu.edu/resources/fa72f9a6-8fd2-4a60-be19-f82e999d7e43/downloads/10947',
    '/vsicurl/https://scholarsphere.psu.edu/resources/5e0a68e1-bc95-4279-9e0c-c9507ac38419/downloads/8651',
    '/vsicurl/https://scholarsphere.psu.edu/resources/00cce6b0-a6bb-487c-893b-0cad6777abfb/downloads/8282',
    '/vsicurl/https://scholarsphere.psu.edu/resources/00cc3034-fa47-4026-bdd1-2b7bb6d983fc/downloads/9932',
    '/vsicurl/https://scholarsphere.psu.edu/resources/c8e66024-830f-4d74-9967-0ce34d0edddb/downloads/11939',
    '/vsicurl/https://scholarsphere.psu.edu/resources/899fda9d-619b-4d48-b566-c57b73a1dc11/downloads/10798',
    '/vsicurl/https://scholarsphere.psu.edu/resources/b0eb7c70-76aa-413b-8df9-6b655e63a6fa/downloads/11002',
    '/vsicurl/https://scholarsphere.psu.edu/resources/1fb742a7-ee26-4136-b72e-80998c351c45/downloads/9254',
    '/vsicurl/https://scholarsphere.psu.edu/resources/3493f35c-2b54-4ed4-8320-add9ad535859/downloads/8103',
    '/vsicurl/https://scholarsphere.psu.edu/resources/e33883e3-261d-4547-b934-12c0abf165f2/downloads/6147',
    '/vsicurl/https://scholarsphere.psu.edu/resources/cb70df68-52ab-4bbe-a627-e5fc560c63ce/downloads/8745',
    '/vsicurl/https://scholarsphere.psu.edu/resources/16cb275e-b350-4ee5-ad21-63ad12d35576/downloads/5951',
    '/vsicurl/https://scholarsphere.psu.edu/resources/fdd76981-a2f7-497f-88db-e6d76b94b612/downloads/5751'
  )
  
  # Process each SoilGrids100 raster file
  for (url in soilgrids_urls) {
    raster <- load_raster(url)
    
    # Check if raster is loaded correctly
    if (is.null(raster)) {
      message("Skipping SoilGrids100 raster for URL: ", url, " due to load failure.")
      next
    }
    
    # Compare CRS of raster and shapefile
    if (!identical(crs(raster), st_crs(shapefile)$wkt)) {
      raster <- project(raster, st_crs(shapefile)$wkt)
    }
    
    index <- which(soilgrids_urls == url)
    output_file_path <- file.path(output_directory, sprintf("sg100_%d_%s.tif", index, basename(output_directory)))
    
    # Check if the output file already exists
    if (file.exists(output_file_path)) {
      message("Output file already exists: ", output_file_path, " - Skipping processing.")
      next
    }
    
    process_raster(raster, shapefile, output_file_path)
  }
}

```



# Snohomish
```{r}
# Snohomish Watershed
output_path <- "C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data"
subfolder <- "Snohomish"
# Load the shapefile
Snohomish_path <- "C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/Watershed_vector-delineations/Snohomish_del.shp"

#Read the shapefile using sf package
Snohomish <- sf::st_read(Snohomish_path)

# Convert the sf object to an sp object
Snohomish_sp <- as(Snohomish, "Spatial")

# Check the CRS and transform if necessary
if (crs(Snohomish_sp)@projargs != CRS("+init=epsg:9001")@projargs) {
  Snohomish_sp <- spTransform(Snohomish_sp, CRS("+init=epsg:9001"))
}
# Run to download and process soil data for a watershed
get_soil_data(Snohomish, output_path, subfolder)
```

# Puget Sound
```{r}
# Puget Sound Watersheds
output_path <- "C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data"
subfolder <- "Puget_Sound"
# Load the shapefile
shape_path <- "C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/Watershed_vector-delineations/PS_watersheds.shp"
Puget <- st_read(shape_path)

# Run to download and process soil data for a watershed
get_soil_data(Puget, output_path, subfolder)
```

# SoilGrids100 (Ramcharan et al., 2017)
```{r}
tn1 <- 'https://scholarsphere.psu.edu/resources/9f534068-9c9a-44d8-b247-8bfc36e61896/downloads/5787'
tn2 <- 'https://scholarsphere.psu.edu/resources/fa72f9a6-8fd2-4a60-be19-f82e999d7e43/downloads/10947'
tn3 <- 'https://scholarsphere.psu.edu/resources/5e0a68e1-bc95-4279-9e0c-c9507ac38419/downloads/8651'
tn4 <- 'https://scholarsphere.psu.edu/resources/00cce6b0-a6bb-487c-893b-0cad6777abfb/downloads/8282'
tn5 <- 'https://scholarsphere.psu.edu/resources/00cc3034-fa47-4026-bdd1-2b7bb6d983fc/downloads/9932'
tn6 <- 'https://scholarsphere.psu.edu/resources/c8e66024-830f-4d74-9967-0ce34d0edddb/downloads/11939'
tn7 <- 'https://scholarsphere.psu.edu/resources/899fda9d-619b-4d48-b566-c57b73a1dc11/downloads/10798'

soc1 <- 'https://scholarsphere.psu.edu/resources/b0eb7c70-76aa-413b-8df9-6b655e63a6fa/downloads/11002'
soc2 <- 'https://scholarsphere.psu.edu/resources/1fb742a7-ee26-4136-b72e-80998c351c45/downloads/9254'
soc3 <- 'https://scholarsphere.psu.edu/resources/3493f35c-2b54-4ed4-8320-add9ad535859/downloads/8103'
soc4 <- 'https://scholarsphere.psu.edu/resources/e33883e3-261d-4547-b934-12c0abf165f2/downloads/6147'
soc5 <- 'https://scholarsphere.psu.edu/resources/cb70df68-52ab-4bbe-a627-e5fc560c63ce/downloads/8745'
soc6 <- 'https://scholarsphere.psu.edu/resources/16cb275e-b350-4ee5-ad21-63ad12d35576/downloads/5951'
soc7 <- 'https://scholarsphere.psu.edu/resources/fdd76981-a2f7-497f-88db-e6d76b94b612/downloads/5751'

# tn
tn_rast1 <- rast(tn1)
tn_rast1_Snohomish <- mask(tn_rast1, Snohomish)
tn_rast1_Snohomish <- trim(tn_rast1_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast1_Snohomish.tif")

tn_rast2 <- rast(tn2)
tn_rast2_Snohomish <- mask(tn_rast2, Snohomish)
tn_rast2_Snohomish <- trim(tn_rast2_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast2_Snohomish.tif")

tn_rast3 <- rast(tn3)
tn_rast3_Snohomish <- mask(tn_rast3, Snohomish)
tn_rast3_Snohomish <- trim(tn_rast3_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast3_Snohomish.tif")

tn_rast4 <- rast(tn4)
tn_rast4_Snohomish <- mask(tn_rast4, Snohomish)
tn_rast4_Snohomish <- trim(tn_rast4_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast4_Snohomish.tif")

tn_rast5 <- rast(tn5)
tn_rast5_Snohomish <- mask(tn_rast5, Snohomish)
tn_rast5_Snohomish <- trim(tn_rast5_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast5_Snohomish.tif")

tn_rast6 <- rast(tn6)
tn_rast6_Snohomish <- mask(tn_rast6, Snohomish)
tn_rast6_Snohomish <- trim(tn_rast6_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast6_Snohomish.tif")

tn_rast7 <- rast(tn7)
tn_rast7_Snohomish <- mask(tn_rast7, Snohomish)
tn_rast7_Snohomish <- trim(tn_rast7_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/tn_rast7_Snohomish.tif")

# soc
soc_rast1 <- rast(soc1)
soc_rast1_Snohomish <- mask(soc_rast1, Snohomish)
soc_rast1_Snohomish <- trim(soc_rast1_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast1_Snohomish.tif")

soc_rast2 <- rast(soc2)
soc_rast2_Snohomish <- mask(soc_rast2, Snohomish)
soc_rast2_Snohomish <- trim(soc_rast2_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast2_Snohomish.tif")

soc_rast3 <- rast(soc3)
soc_rast3_Snohomish <- mask(soc_rast3, Snohomish)
soc_rast3_Snohomish <- trim(soc_rast3_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast3_Snohomish.tif")

soc_rast4 <- rast(soc4)
soc_rast4_Snohomish <- mask(soc_rast4, Snohomish)
soc_rast4_Snohomish <- trim(soc_rast4_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast4_Snohomish.tif")

soc_rast5 <- rast(soc5)
soc_rast5_Snohomish <- mask(soc_rast5, Snohomish)
soc_rast5_Snohomish <- trim(soc_rast5_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast5_Snohomish.tif")

soc_rast6 <- rast(soc6)
soc_rast6_Snohomish <- mask(soc_rast6, Snohomish)
soc_rast6_Snohomish <- trim(soc_rast6_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast6_Snohomish.tif")

soc_rast7 <- rast(soc7)
soc_rast7_Snohomish <- mask(soc_rast7, Snohomish)
soc_rast7_Snohomish <- trim(soc_rast7_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/soc_rast7_Snohomish.tif")
```

```{r}
# Crop the COG using the shapefile boundary
clay_0_Snohomish <- mask(clay_0, Snohomish)
clay_0_Snohomish <- trim(clay_0_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/clay_0_Snohomish.tif")

bedrock_Snohomish <- mask(bedrock, Snohomish)
bedrock_Snohomish <- trim(bedrock_Snohomish, filename="C:/R_Drive/Data_Files/LPKS_Data/R_Projects/VELMA.Soil/data/raw_data/bedrock_Snohomish.tif")

```
```{r}

```

